{
  "uid": "api-metrics-dashboard",
  "title": "API Metrics",
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "panels": [
    {
      "type": "row",
      "title": "Application Overview",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 1 }
    },
    {
      "type": "stat",
      "title": "Current Request Rate",
      "targets": [
        {
          "expr": "sum(rate(http_requests_total[1m]))",
          "legendFormat": "RPS"
        }
      ],
      "gridPos": { "x": 0, "y": 1, "w": 6, "h": 4 },
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      }
    },
    {
      "type": "stat",
      "title": "Error Rate (5xx)",
      "targets": [
        {
          "expr": "sum(rate(http_requests_total{status_code=~\"5..\"}[1m])) / sum(rate(http_requests_total[1m])) * 100",
          "legendFormat": "Error %"
        }
      ],
      "gridPos": { "x": 6, "y": 1, "w": 6, "h": 4 },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "reduceOptions": { "calcs": ["mean"], "values": false },
        "textMode": "auto",
        "unit": "percent"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 1 }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "P99 Latency",
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P99"
        }
      ],
      "gridPos": { "x": 12, "y": 1, "w": 6, "h": 4 },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "unit": "s"
      }
    },
    {
      "type": "gauge",
      "title": "Concurrent Requests",
      "targets": [
        {
          "expr": "sum(http_inflight_requests)",
          "legendFormat": "Inflight"
        }
      ],
      "gridPos": { "x": 18, "y": 1, "w": 6, "h": 4 },
      "options": {
        "showThresholdLabels": false,
        "showThresholdMarkers": true,
        "reduceOptions": { "calcs": ["lastNotNull"], "values": false }
      }
    },
    {
      "type": "row",
      "title": "Traffic & Saturation",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 5, "w": 24, "h": 1 }
    },
    {
      "type": "timeseries",
      "title": "Requests per Second by Status",
      "targets": [
        {
          "expr": "sum(rate(http_requests_total[1m])) by (status_code)",
          "legendFormat": "{{status_code}}"
        }
      ],
      "gridPos": { "x": 0, "y": 6, "w": 12, "h": 8 },
      "fieldConfig": {
        "defaults": {
          "custom": { "lineWidth": 2, "fillOpacity": 10, "drawStyle": "line" }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Top Endpoints (RPS)",
      "targets": [
        {
          "expr": "topk(5, sum(rate(http_requests_total[1m])) by (route))",
          "legendFormat": "{{route}}"
        }
      ],
      "gridPos": { "x": 12, "y": 6, "w": 12, "h": 8 },
      "fieldConfig": {
        "defaults": { "custom": { "lineWidth": 2, "fillOpacity": 10 } }
      }
    },
    {
      "type": "row",
      "title": "Latency Analysis",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 14, "w": 24, "h": 1 }
    },
    {
      "type": "timeseries",
      "title": "Response Time Percentiles",
      "targets": [
        {
          "expr": "histogram_quantile(0.5, sum(rate(http_request_duration_seconds_bucket[2m])) by (le))",
          "legendFormat": "P50"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[2m])) by (le))",
          "legendFormat": "P95"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[2m])) by (le))",
          "legendFormat": "P99"
        }
      ],
      "gridPos": { "x": 0, "y": 15, "w": 24, "h": 8 },
      "fieldConfig": {
        "defaults": { "unit": "s", "custom": { "fillOpacity": 0 } }
      }
    },
    {
      "type": "row",
      "title": "Node.js Runtime Metrics",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 23, "w": 24, "h": 1 }
    },
    {
      "type": "timeseries",
      "title": "CPU Usage",
      "targets": [
        {
          "expr": "rate(process_cpu_user_seconds_total[1m])",
          "legendFormat": "User"
        },
        {
          "expr": "rate(process_cpu_system_seconds_total[1m])",
          "legendFormat": "System"
        }
      ],
      "gridPos": { "x": 0, "y": 24, "w": 8, "h": 8 },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "custom": { "fillOpacity": 15, "stacking": { "mode": "normal" } }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Memory Usage (Heap)",
      "targets": [
        {
          "expr": "nodejs_heap_size_used_bytes",
          "legendFormat": "Used"
        },
        {
          "expr": "nodejs_heap_size_total_bytes",
          "legendFormat": "Total"
        }
      ],
      "gridPos": { "x": 8, "y": 24, "w": 8, "h": 8 },
      "fieldConfig": {
        "defaults": { "unit": "bytes", "custom": { "fillOpacity": 15 } }
      }
    },
    {
      "type": "timeseries",
      "title": "Event Loop Lag",
      "targets": [
        {
          "expr": "nodejs_eventloop_lag_seconds",
          "legendFormat": "Lag"
        }
      ],
      "gridPos": { "x": 16, "y": 24, "w": 8, "h": 8 },
      "fieldConfig": {
        "defaults": { "unit": "s" }
      }
    }
  ]
}
